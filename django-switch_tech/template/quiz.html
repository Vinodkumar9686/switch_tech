<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <title>Quiz</title>
    <script type="text/javascript">
        function preventBack() { window.history.forward(); }
        setTimeout("preventBack()", 0);
        window.onunload = function () { null };
    </script>
     
    <style>
        header {
          background-color: #333;
          color: #fff;
          padding: 10px;
          text-align: center;
        }
        h1 {
          margin: 0;
          font-size: 36px;
        }
        p {
          font-size: 18px;
          line-height: 1.5;
          margin-bottom: 20px;
        }
        .logo {
          max-width: 200px;
          margin: 10px;
        }
    </style>
</head>
<body>
    <header>
        <img align="left" class="logo" src="https://static.ambitionbox.com/assets/v2/images/rs:fit:200:200:false:false/bG9jYWw6Ly8vbG9nb3Mvb3JpZ2luYWxzL3JhdG5hLWdsb2JhbC10ZWNobm9sb2dpZXMuanBn.webp" alt="Logo">
        <h1>Quiz Page</h1>
    </header>
    <main>
        <!-- <h3>Welcome to our quiz page. This quiz will test your knowledge on {selectedTechnology} </h3> -->
    </main>

    <form method="POST" action="result">
        {% csrf_token %}
        <div id="app">
            <div class="container mt-5">
                <div class="col-md-6 mx-auto">
                    <div v-for="(question, index) in questions" class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Question [[index + 1]]</h5>
                            <p class="card-text">[[question.question]]</p>
                            <div class="form-check" v-for="answer in question.answers">
                                <input type="radio" @change="checkAnswer($event, question.uid, answer.is_correct)" :value="answer.answer"
                                    :name="'question-' + question.uid"  id="flexRadioDefault1" class="form-check-input">
                                <label class="form-check-label" for="flexRadioDefault1">[[answer.answer]]</label>
                            </div>
                        </div>
                    </div>
                    <center><button type="button" class="btn btn-danger" id="submit-btn" @click="submitQuiz">Submit</button></center>
                </div>
            </div>
        </div>
    </form>

    <div id="timer" style="position: fixed; top: 90px; right: 10px;"></div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
    <script>

    var countdown = {{ new_timer }}; // Total time in seconds
    var timerDisplay = document.getElementById('timer');

    function updateTimer() {
        var minutes = Math.floor(countdown / 60);
        var seconds = countdown % 60;

        // Format the time with leading zeros
        var formattedTime = minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');

        timerDisplay.textContent = "Time Remaining: " + formattedTime; // Update the text content of the timer display element

        if (countdown === 0) {
            document.getElementById('submit-btn').click();
        } else {
            countdown--;
            setTimeout(updateTimer, 1000);
        }
    }

    window.addEventListener('beforeunload', function(event) {
        var category = '{{ category }}'
        event.preventDefault();
        saveRemainingTime(countdown, category);
        event.returnValue = '';
    });

    function saveRemainingTime(remainingTime, category) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const formData = new FormData();
        formData.append('remainingTime', remainingTime);
        formData.append('category', category);

        fetch('/api/save-remaining-time/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken,
            }
        }).then(response => {
            console.log('Remaining time saved successfully');
        }).catch(error => {
            console.error('Error saving remaining time:', error);
        });
    }
    updateTimer();
    setTimeout(function() {
      app.submitQuiz();
    }, countdown * 1000);

    console.log('Vue.js code loaded');
    console.log('Category:', '{{ category }}');
    var app = new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        data() {
            return {
                category: '{{ category }}',
                questions: [],
                score: 0
            }
        },

        methods: {

            getQuestions() {
                var _this = this
                fetch(`/api/get-quiz/?category=${_this.category}`)
                    .then(response => response.json())
                    .then(result => {
                        console.log(result)
                        _this.questions = result.data
                    })
            },
            checkAnswer(event, uid, isCorrect) {
                if (isCorrect) {
                    this.score++
                    console.log("answer is correct")
                } else {
                    console.log("Incorrect")
                }
            },
            submitQuiz() {
                event.preventDefault();
                const scoreData = { score: this.score, category: this.category }
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value; // get the CSRF token from the page
                console.log(JSON.stringify(scoreData))

                const formData = new FormData()
                formData.append('score', this.score)

                fetch(`/api/result/`, {
                    method: 'POST',
                    body: JSON.stringify(scoreData),
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken, // include the CSRF token in the request headers
                    }
                }).then(response => {
                    console.log('Score submitted successfully')
                    window.location.href = "/final/";
                }).catch(error => {
                    console.error('Error submitting score:', error)
                })
            },
        },
        created() {
            this.getQuestions()
            console.log('Loaded')
        },
    });
</script>
</body>
</html>
